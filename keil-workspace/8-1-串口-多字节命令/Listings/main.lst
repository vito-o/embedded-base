C51 COMPILER V9.54   MAIN                                                                  11/08/2024 18:05:41 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: D:\software\Keil\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listing
                    -s\main.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          #include <REGX52.H>
   2          #include <Timer0.h>
   3          //#include "Delay.h"
   4          #include <string.h>
   5          
   6          void init_UART()
   7          {
   8   1          // 1.è®¾ç½®ä¸²å£å·¥ä½œæ¨¡å¼
   9   1          SM0 = 0;
  10   1          SM1 = 1;
  11   1        
  12   1          // 2.è®¾ç½®æ³¢ç‰¹ç‡
  13   1          // 2.1 SMOD
  14   1          PCON &= 0x7F;
  15   1          // 2.2 å®šæ—¶å™¨1
  16   1          // 2.2.1 å·¥ä½œæ¨¡å¼è®¾ç½®
  17   1          TMOD &= 0x0F;
  18   1          TMOD |= 0x20;
  19   1          // 2.2.2 æº¢å‡ºåˆå§‹å€¼è®¾ç½®
  20   1          // æ„æ€å°±æ˜¯è¿‡æ¥çš„æ—¶é’Ÿé¢‘ç‡ åœ¨253çš„åŸºç¡€ä¸Šï¼Œæ¯ä¸ªæ—¶é’Ÿé¢‘ç‡åŠ 1ï¼Œ è¾¾åˆ°æº¢å‡ºæ‰äº§ç”
             -Ÿä¸€æ¬¡å®šæ—¶
  21   1          TL1 = 253;
  22   1          TH1 = 253;
  23   1          // 2.2.3 å¯åŠ¨å®šæ—¶å™¨
  24   1          TR1 = 1;
  25   1        
  26   1          // 3.æ¥æ”¶æ•°æ®ç›¸å…³
  27   1          REN = 1; //å¼€å¯æ•°æ®æ¥æ”¶
  28   1          SM2 = 0; //æ˜¯å¦æ£€æµ‹åœæ­¢ä½çš„æœ‰æ•ˆæ€§ï¼ˆé«˜ç”µå¹³æœ‰æ•ˆï¼‰ 1:æ£€æµ‹ï¼Œ0ï¼šä¸æ£€æµ‹  
  29   1          
  30   1          // 4.ä¸²å£ä¸­æ–­ç›¸å…³é…ç½®
  31   1          ES = 1;
  32   1          EA = 1;
  33   1          
  34   1          RI = 0;
  35   1          TI = 0;
  36   1      }
  37          
  38          // æ˜¯å¦æ­£åœ¨å‘é€
  39          static unsigned char bit_is_sending = 0;
  40          // æ¥æ”¶æ•°æ®å˜é‡
  41          static unsigned char s_buffer[16] = {0};
  42          static unsigned char s_index = 0;
  43          
  44          static unsigned char s_is_complete = 0;
  45          static unsigned char s_time_count = 0;
  46          
  47          
  48          // å‘é€ä¸€ä¸ªå­—ç¬¦æ•°æ®
  49          void UART_sendChar(char c)
  50          {
  51   1        while(bit_is_sending == 1);
  52   1        bit_is_sending = 1;
  53   1        SBUF = c;
C51 COMPILER V9.54   MAIN                                                                  11/08/2024 18:05:41 PAGE 2   

  54   1      }
  55          
  56          // å‘é€å­—ç¬¦ä¸²
  57          void UART_sendStr(char *str)
  58          {
  59   1        while(*str != '\0') {
  60   2          UART_sendChar(*str);
  61   2          str++;
  62   2        } 
  63   1      }
  64          
  65          // éªŒè¯æ˜¯å¦æ¥æ”¶æ•°æ®
  66          bit UART_receiveStr(char *str)
  67          {
  68   1        unsigned char i;
  69   1        
  70   1        if (s_is_complete) {
  71   2          for(i = 0; i < s_index; i++) {
  72   3            str[i] = s_buffer[i];
  73   3          }
  74   2          str[i] = '\0';
  75   2          s_index = 0;
  76   2          s_is_complete = 0;
  77   2          
  78   2          return 1;
  79   2        } else {
  80   2          return 0;
  81   2        }
  82   1      }
  83          
  84          char command[16] = {0};
  85          void main() 
  86          {
  87   1        Timer0_Init();
  88   1        init_UART();
  89   1        
  90   1        while(1)
  91   1        {
  92   2          if (UART_receiveStr(command)) {
  93   3            if(strcmp(command, "on") == 0) {
  94   4              P2 = 0x00;
  95   4              UART_sendStr("ok: LED is on");
  96   4            } else if (strcmp(command, "off") == 0) {
  97   4              P2 = 0xFF;
  98   4              UART_sendStr("ok: LED is off");
  99   4            } else {
 100   4              UART_sendStr("Error: Unknown command");
 101   4            }
 102   3          }
 103   2        }
 104   1      
 105   1      }
 106          
 107          
 108          void UART_Routine(void) interrupt 4
 109          {
 110   1        if (RI == 1) {
 111   2          //s_buffer = SBUF;
 112   2          s_buffer[s_index++] = SBUF;
 113   2          s_time_count = 0; //å®šæ—¶å™¨ï¼Œæ¯æ¬¡æ¥æ”¶åˆ°æ•°æ®åï¼Œs_time_counté‡ç½®
 114   2          RI = 0; //åœ¨ä¸­æ–­ä¸­æ‰‹åŠ¨å¯¹ä¸²å£æ ‡å¿—ä½é‡ç½®
 115   2        }
C51 COMPILER V9.54   MAIN                                                                  11/08/2024 18:05:41 PAGE 3   

 116   1        
 117   1        if (TI == 1) {
 118   2          bit_is_sending = 0;
 119   2          
 120   2          TI = 0; //åœ¨ä¸­æ–­ä¸­æ‰‹åŠ¨å¯¹ä¸²å£æ ‡å¿—ä½é‡ç½®
 121   2        }
 122   1      }
 123          
 124          // å®šæ—¶å™¨
 125          void Timer0_Routine() interrupt 1
 126          {
 127   1        TH0 = 64535/256;
 128   1        TL0 = 64535%256;
 129   1        s_time_count++;
 130   1        
 131   1        if (s_index > 0 && s_time_count >= 10) {
 132   2          s_is_complete = 1;
 133   2          s_time_count = 0;
 134   2        }
 135   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    299    ----
   CONSTANT SIZE    =     59    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     36       3
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
